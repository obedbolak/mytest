name: Deploy Next.js App

on:
  push:
    branches:
      - main  # Change to your default branch if different
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            APP_DIR="/root/mytest"
            REPO_SSH="git@github.com:obedbolak/mytest.git"
            BRANCH="main"

            # If the repo already exists, fetch and reset to the remote branch. Otherwise clone.
            if [ -d "$APP_DIR/.git" ]; then
              cd "$APP_DIR"
              git fetch --all --prune
              git reset --hard "origin/$BRANCH"
            else
              git clone --depth 1 -b "$BRANCH" "$REPO_SSH" "$APP_DIR"
              cd "$APP_DIR"
            fi

            # Load Node.js into PATH (adjust path if needed)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # Alternative: Add common Node.js installation paths
            export PATH="/usr/local/bin:/usr/bin:$HOME/.nvm/versions/node/$(ls $HOME/.nvm/versions/node | tail -1)/bin:$PATH"
            
            # Check Node availability
            if ! command -v node >/dev/null 2>&1; then
              echo "Node.js not found in PATH. Install Node on the server or adjust PATH."
              exit 1
            fi
            
            # Check PM2 availability and install if missing
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "PM2 not found, installing globally..."
              npm install -g pm2
            fi

            # Install dependencies (use npm ci for reproducible installs)
            npm ci

            # Build using package.json script
            npm run build

            # Ensure the app runs on PORT 3003
            export PORT=3003

            # Restart or start the app with pm2
            if command -v pm2 >/dev/null 2>&1; then
              pm2 describe mytest >/dev/null 2>&1 && pm2 restart mytest --update-env || PORT=3003 pm2 start npm --name "mytest" -- start
              pm2 save
            else
              echo "pm2 not found; please install 'pm2' globally: npm i -g pm2"
              exit 1
            fi

            echo "Deployment completed successfully on port 3003!"